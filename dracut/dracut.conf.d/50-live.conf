# ==============================================================
# 50-live.conf â€” configurazione Dracut per Live ISO cifrata (CORRETTO)
# ==============================================================

dracut_modules_dir+=" /usr/lib/penguins-eggs/dracut/modules.d "

# Compressione
compress="zstd"

# Non limitare ai soli device host
hostonly="no"

# Disabilita configurazioni locali non necessarie
lvmconf="no"
mdadmconf="no"

# Compressione anche per squashfs
squash_compress="zstd"

# ==============================================================
# Moduli fondamentali per ISO live cifrata
# ==============================================================

# Moduli base live
add_dracutmodules+=" dmsquash-live dmsquash-live-autooverlay 95iso-scan pollcdrom "

# Moduli per cifratura su file loop (LUKS)
# CORRETTO: Aggiunto il modulo 95luks-loop e il modulo di debug col nome giusto
add_dracutmodules+=" 95luks-loop 00debug-shell "

# Moduli utili per avvio generico
add_dracutmodules+=" kernel-modules qemu qemu-net livenet "

# Evita di includere Plymouth (non necessario nei live minimal)
omit_dracutmodules+=" plymouth "

# ==============================================================
# Parametri del kernel da preimpostare
# ==============================================================

# CORRETTO: Sostituito rd.shell con startdebug=1 per il nostro modulo custom
kernel_cmdline="boot=live root=live:LABEL=colibri rd.luks.loop=/live/luks.img eggs.luks.uuid=fedb19f3-e117-4e94-a85c-debe41b18e5b rd.live.squashimg=filesystem.squashfs rd.live.overlay.overlayfs=1 rd.debug startdebug=1"

# ==============================================================
# Ottimizzazioni
# ==============================================================

# CORRETTO: Aggiornati i percorsi a /usr/sbin e /bin come richiesto da Debian
install_items+=" /usr/sbin/cryptsetup /usr/sbin/losetup /usr/bin/find /usr/bin/lsblk /bin/cat /bin/mount /bin/umount "

# Non fermarti se manca qualche modulo opzionale
dracutmodules_load="yes"

# Disabilita microcode early
early_microcode="no"

# ==============================================================
# Fine file
# ==============================================================