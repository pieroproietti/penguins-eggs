# ==============================================================
# 50-live.conf – Configurazione per Penguins-Eggs
# Dracut 106 - Debian Trixie
# ==============================================================

# CRITICAL FIX: La variabile corretta per Dracut 106 è "dracutmodules_dirs"
# NON "dracut_modules_dir" (che non esiste!)
# sto usando i symlink
# dracutmodules_dirs+=" /usr/lib/penguins-eggs/dracut/modules.d " 

# Compressione
compress="zstd"
squash_compress="zstd"

# Configurazione generale
hostonly="no"
lvmconf="no"
mdadmconf="no"
early_microcode="no"

# ORDINE CRITICO dei moduli (rispetta le dipendenze!)
# 1. Moduli base
add_dracutmodules+=" dm kernel-modules "

# 2. Block device support (dummy per compatibilità)
add_dracutmodules+=" block "

# 3. Scansione ISO e rilevamento media
add_dracutmodules+=" iso-scan pollcdrom "

# 4. LUKS support (DEVE venire dopo iso-scan)
add_dracutmodules+=" luks luks-loop "

# 5. Sistema live (DEVE venire dopo LUKS)
add_dracutmodules+=" dmsquash-live dmsquash-live-autooverlay "

# 6. Rete e virtualizzazione
add_dracutmodules+=" livenet qemu qemu-net "

# 7. Debug (ultimo modulo)
add_dracutmodules+=" debug-shell "

# Moduli da escludere
omit_dracutmodules+=" plymouth "

# Parametri kernel per il boot live con LUKS cifrato
kernel_cmdline="boot=live root=live:LABEL=colibri rd.luks.loop=/live/luks.img eggs.luks.uuid=fedb19f3-e117-4e94-a85c-debe41b18e5b rd.live.squashimg=filesystem.squashfs rd.live.overlay.overlayfs=1 rd.debug startdebug=1"

# Strumenti essenziali da includere nell'initrd
install_items+=" /usr/sbin/cryptsetup "
install_items+=" /usr/sbin/losetup "
install_items+=" /usr/bin/find "
install_items+=" /usr/bin/lsblk "
install_items+=" /bin/cat "
install_items+=" /bin/mount "
install_items+=" /bin/umount "
install_items+=" /usr/bin/blkid "
install_items+=" /usr/sbin/udevadm "
install_items+=" /usr/bin/findfs "