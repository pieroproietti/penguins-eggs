# NOME: 2-build-publish-ALL-release

name: 0. Build/publish ALL with release

env:
  BOOTLOADERS_VERSION: v25.9.8

on:
  workflow_dispatch:

jobs:
  # ========================================================
  # 1.1 JOB DI BUILD Debian (INVARIATO)
  # ========================================================
  build-debian:
    runs-on: ubuntu-latest
    container:
      image: debian:13
    
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4

      - name: 2. Install Debian Build Dependencies
        run: |
          apt-get update
          apt-get install -y curl gpg git build-essential dpkg-dev fakeroot gnupg2 apt-utils xz-utils
          mkdir -p /etc/apt/keyrings
          curl -fsSL https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key | gpg --dearmor -o /etc/apt/keyrings/nodesource.gpg
          echo "deb [signed-by=/etc/apt/keyrings/nodesource.gpg] https://deb.nodesource.com/node_20.x nodistro main" | tee /etc/apt/sources.list.d/nodesource.list
          apt-get update
          apt-get install -y nodejs
          npm install -g pnpm

      - name: 3. Import GPG Key and Prime Agent
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import --batch
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null

      - name: 4. Build .deb packages for all architectures
        run: |
          export GPG_TTY=$(tty)
          pnpm install
          pnpm deb -a

      - name: 5. Upload Debian Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-packages
          path: |
            releases/*.deb
            releases/*.sha256
          retention-days: 1    

  # ========================================================
  # 1.2 JOB DI BUILD Fedora (MODIFICATO)
  # ========================================================
  build-fc42:
    runs-on: ubuntu-latest
    container:
      image: fedora:42
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 2. Install Build Dependencies (with jq)
        run: |
          dnf install -y 'dnf-plugins-core' rpm-build git tar gzip curl gnupg2 rpmsign jq
          for package in $(grep '^BuildRequires:' packaging/rpm/penguins-eggs.spec | awk '{print $2}'); do
            dnf install -y "$package"
          done
      - name: 3. Get Package Version from package.json
        id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
      
      # --- MODIFICA: Aggiunto step per leggere il file 'release' ---
      - name: 3a. Get Package Release from 'release' file
        id: release
        run: echo "release_num=$(cat release | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      # --- MODIFICA: Aggiorna sia Versione che Release ---
      - name: 4. Update Version and Release in .spec File
        run: |
          echo "Updating .spec file to version ${{ steps.version.outputs.version }} and release ${{ steps.release.outputs.release_num }}"
          sed -i "s/^\(Version: *\).*/\1${{ steps.version.outputs.version }}/" packaging/rpm/penguins-eggs.spec
          sed -i "s/^\(Release: *\).*/\1${{ steps.release.outputs.release_num }}%{?dist}/" packaging/rpm/penguins-eggs.spec
      
      - name: 5. Import GPG Key and Configure RPM
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import --batch
          echo '%_signature gpg' > ~/.rpmmacros
          echo '%_gpg_name ${{ secrets.GPG_KEY_ID }}' >> ~/.rpmmacros
      - name: 6. Prepare RPM Sources
        run: |
          mkdir -p $HOME/rpmbuild/SOURCES
          tar -czf $HOME/rpmbuild/SOURCES/penguins-eggs.tar.gz \
            --transform='s,^\.,penguins-eggs-${{ steps.version.outputs.version }},' \
            --exclude=.git --exclude=.github .
          curl -LO https://github.com/pieroproietti/penguins-bootloaders/releases/download/${{ env.BOOTLOADERS_VERSION }}/bootloaders.tar.gz
          cp bootloaders.tar.gz $HOME/rpmbuild/SOURCES/
      - name: 7. Build and Sign RPM package
        id: build
        env:
          GPG_PASSPHRASE_ENV: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "$GPG_PASSPHRASE_ENV" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null
          rpmbuild -ba packaging/rpm/penguins-eggs.spec
          rpmsign --addsign $(find $HOME/rpmbuild/RPMS -name '*.rpm')
          echo "rpm_path=$(find $HOME/rpmbuild/RPMS -name '*.rpm')" >> $GITHUB_OUTPUT
      - name: 8. Upload RPM Artifact for publishing
        uses: actions/upload-artifact@v4
        with:
          name: fedora-42-rpm-for-repo
          path: ${{ steps.build.outputs.rpm_path }}

  # ========================================================
  # 1.3 JOB DI BUILD Opensuse (MODIFICATO)
  # ========================================================
  build-opensuse:
    runs-on: ubuntu-latest
    container:
      image: opensuse/leap
    steps:
      - name: 0. Install Prerequisite Tools
        run: |
          zypper --non-interactive refresh
          zypper --non-interactive install git tar gzip
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 2. Install Build Dependencies (with jq)
        run: |
          zypper --non-interactive install rpm-build curl gpg2 rsync nodejs-devel jq
          zypper modifyrepo --enable repo-source
          zypper --non-interactive refresh
          npm install -g pnpm
      - name: 3. Get Package Version from package.json
        id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
      
      # --- MODIFICA: Aggiunto step per leggere il file 'release' ---
      - name: 3a. Get Package Release from 'release' file
        id: release
        run: echo "release_num=$(cat release | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      # --- MODIFICA: Aggiorna sia Versione che Release prima di copiare .spec.suse ---
      - name: 4. Update .spec and Install Dependencies
        run: |
          echo "Updating .spec file to version ${{ steps.version.outputs.version }} and release ${{ steps.release.outputs.release_num }}"
          sed -i "s/^\(Version: *\).*/\1${{ steps.version.outputs.version }}/" packaging/rpm/penguins-eggs.spec
          sed -i "s/^\(Release: *\).*/\1${{ steps.release.outputs.release_num }}%{?dist}/" packaging/rpm/penguins-eggs.spec
          
          cp packaging/rpm/penguins-eggs.spec packaging/rpm/penguins-eggs.spec.suse
          sed -i -e '/%if 0%{?suse_version}/,/%endif/c\BuildRequires:  nodejs-devel' packaging/rpm/penguins-eggs.spec.suse
          sed -i -e '/%if %{expr: 0%{?fedora} || 0%{?suse_version}}/,/%endif/c\BuildRequires:  pnpm' packaging/rpm/penguins-eggs.spec.suse
          sed -i '/BuildRequires: *pnpm/d' packaging/rpm/penguins-eggs.spec.suse
          echo "Installing RPM build dependencies from simplified spec file..."
          for package in $(grep '^BuildRequires:' packaging/rpm/penguins-eggs.spec.suse | awk '{print $2}'); do
            echo "Installing $package..."
            zypper --non-interactive install "$package"
          done
      
      - name: 5. Import GPG Key and Configure RPM
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import --batch
          echo '%_signature gpg' > ~/.rpmmacros
          echo '%_gpg_name ${{ secrets.GPG_KEY_ID }}' >> ~/.rpmmacros
      - name: 6. Prepare RPM Sources
        working-directory: ${{ github.workspace }}
        run: |
          STAGING_DIR="/tmp/staging"
          SOURCE_DIR_NAME="penguins-eggs-${{ steps.version.outputs.version }}"
          mkdir -p "$STAGING_DIR/$SOURCE_DIR_NAME"
          rsync -av --exclude '.git' --exclude '.github' ./ "$STAGING_DIR/$SOURCE_DIR_NAME/"
          mkdir -p $HOME/rpmbuild/SOURCES
          tar -czf $HOME/rpmbuild/SOURCES/penguins-eggs.tar.gz -C "$STAGING_DIR" "$SOURCE_DIR_NAME"
          curl -LO https://github.com/pieroproietti/penguins-bootloaders/releases/download/${{ env.BOOTLOADERS_VERSION }}/bootloaders.tar.gz
          cp bootloaders.tar.gz $HOME/rpmbuild/SOURCES/
      - name: 7. Build and Sign RPM package
        id: build
        run: |
          export GPG_TTY=$(tty)
          echo '%_topdir %(echo $HOME)/rpmbuild' >> ~/.rpmmacros
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null
          rpmbuild -ba packaging/rpm/penguins-eggs.spec.suse
          echo "rpm_path=$(find $HOME/rpmbuild/RPMS -name '*.rpm')" >> $GITHUB_OUTPUT
      - name: 8. Upload RPM Artifact for publishing
        uses: actions/upload-artifact@v4
        with:
          name: opensuse-leap-rpm-for-repo
          path: ${{ steps.build.outputs.rpm_path }}

  # ========================================================
  # 1.4 JOB DI BUILD EL9 (MODIFICATO)
  # ========================================================
  build-el9:
    runs-on: ubuntu-latest
    container:
      image: almalinux:9
    steps:
      - name: 0. Install Prerequisite Tools
        run: |
          dnf install -y --allowerasing git tar gzip
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: 2. Install Build Dependencies (with jq)
        run: |
          dnf install -y --allowerasing 'dnf-plugins-core' rpm-build curl gnupg2 rpm-sign jq
          dnf install -y epel-release
          /usr/bin/crb enable
          dnf module enable nodejs:18 -y
          dnf install -y nodejs
          npm install -g pnpm
          echo "Installing RPM build dependencies from spec file..."
          for package in $(grep '^BuildRequires:' packaging/rpm/penguins-eggs.spec | grep -v 'pnpm' | awk '{print $2}'); do
            echo "Installing $package..."
            dnf install -y --allowerasing "$package"
          done
      - name: 3. Get Package Version from package.json
        id: version
        run: echo "version=$(jq -r .version package.json)" >> $GITHUB_OUTPUT
      
      # --- MODIFICA: Aggiunto step per leggere il file 'release' ---
      - name: 3a. Get Package Release from 'release' file
        id: release
        run: echo "release_num=$(cat release | tr -d '[:space:]')" >> $GITHUB_OUTPUT

      # --- MODIFICA: Aggiorna sia Versione che Release ---
      - name: 4. Update Version and Release in .spec File
        run: |
          echo "Updating .spec file to version ${{ steps.version.outputs.version }} and release ${{ steps.release.outputs.release_num }}"
          sed -i "s/^\(Version: *\).*/\1${{ steps.version.outputs.version }}/" packaging/rpm/penguins-eggs.spec
          sed -i "s/^\(Release: *\).*/\1${{ steps.release.outputs.release_num }}%{?dist}/" packaging/rpm/penguins-eggs.spec
      
      - name: 5. Import GPG Key and Configure RPM
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import --batch
          echo '%_signature gpg' > ~/.rpmmacros
          echo '%_gpg_name ${{ secrets.GPG_KEY_ID }}' >> ~/.rpmmacros
      - name: 6. Prepare RPM Sources
        run: |
          mkdir -p $HOME/rpmbuild/SOURCES
          tar -czf $HOME/rpmbuild/SOURCES/penguins-eggs.tar.gz \
            --transform='s,^\.,penguins-eggs-${{ steps.version.outputs.version }},' \
            --exclude=.git --exclude=.github .
          curl -LO https://github.com/pieroproietti/penguins-bootloaders/releases/download/${{ env.BOOTLOADERS_VERSION }}/bootloaders.tar.gz
          cp bootloaders.tar.gz $HOME/rpmbuild/SOURCES/
      - name: 7. Build and Sign RPM package
        id: build
        run: |
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null
          rpmbuild -ba packaging/rpm/penguins-eggs.spec
          rpmsign --addsign $(find $HOME/rpmbuild/RPMS -name '*.rpm')
          echo "rpm_path=$(find $HOME/rpmbuild/RPMS -name '*.rpm')" >> $GITHUB_OUTPUT
      - name: 8. Upload RPM Artifact for publishing
        uses: actions/upload-artifact@v4
        with:
          name: el9-rpm-for-repo
          path: ${{ steps.build.outputs.rpm_path }}

  # ========================================================
  # 1.5 JOB DI BUILD Archlinux (MODIFICATO)
  # ========================================================
  build-arch:
    runs-on: ubuntu-latest
    container:
      image: archlinux
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
      - name: 2. Prepare Build Environment
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git pnpm jq pacman-contrib gnupg
      
      # --- MODIFICA: Legge 'release' e aggiorna pkgrel ---
      - name: 2a. Update PKGBUILD
        run: |
          VERSION=$(jq -r .version package.json)
          RELEASE_NUM=$(cat release | tr -d '[:space:]')
          echo "Updating PKGBUILD to $VERSION-$RELEASE_NUM"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" ./packaging/arch/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=$RELEASE_NUM/" ./packaging/arch/PKGBUILD
      
      - name: 3. Create Build User
        run: |
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"

      - name: 4. Import GPG Key and Prime Agent (for builder)
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | sudo -u builder gpg --import --batch
          sudo -u builder bash -c 'mkdir -p ~/.gnupg'
          sudo -u builder bash -c 'echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf'
          sudo -u builder bash -c 'echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf'
          sudo -u builder gpg-connect-agent reloadagent /bye
          echo "${{ secrets.GPG_PASSPHRASE }}" | sudo -u builder gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null
      
      - name: 5. Update Checksums and Build Package
        run: |
          sudo -u builder GPGKEY=${{ secrets.GPG_KEY_ID }} bash -c "cd ./packaging/arch && updpkgsums && makepkg -s -f --noconfirm"
      
      - name: 6. Upload Arch Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: arch-packages
          path: |
            ./packaging/arch/*.pkg.tar.zst
            ./packaging/arch/*.pkg.tar.zst.sig

  # ========================================================
  # 1.6 JOB DI BUILD Manjaro (MODIFICATO)
  # ========================================================
  build-manjaro:
    runs-on: ubuntu-latest
    container:
      image: manjarolinux/base
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
      - name: 2. Prepare Build Environment and Dependencies
        run: |
          pacman -Syu --noconfirm
          pacman -S --noconfirm base-devel git pnpm jq pacman-contrib gnupg

      # --- MODIFICA: Legge 'release' e aggiorna pkgrel ---
      - name: 2a. Update PKGBUILD with version and release
        run: |
          VERSION=$(jq -r .version package.json)
          RELEASE_NUM=$(cat release | tr -d '[:space:]')
          echo "Updating Manjaro PKGBUILD to version: $VERSION, release: $RELEASE_NUM"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" ./packaging/manjaro/PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=$RELEASE_NUM/" ./packaging/manjaro/PKGBUILD
          echo "PKGBUILD updated:"
          grep -E "^(pkgver|pkgrel)=" ./packaging/manjaro/PKGBUILD
      
      - name: 3. Prepare Build User
        run: |
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          chown -R builder:builder "$GITHUB_WORKSPACE"
        
      - name: 3a. Import GPG Key and Prime Agent (for builder)
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | sudo -u builder gpg --import --batch
          sudo -u builder bash -c 'mkdir -p ~/.gnupg'
          sudo -u builder bash -c 'echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf'
          sudo -u builder bash -c 'echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf'
          sudo -u builder gpg-connect-agent reloadagent /bye
          echo "${{ secrets.GPG_PASSPHRASE }}" | sudo -u builder gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null
        
      - name: 4. Update Checksums and Build Package as Non-Root User
        run: |
          sudo -u builder GPGKEY=${{ secrets.GPG_KEY_ID }} updpkgsums
          sudo -u builder GPGKEY=${{ secrets.GPG_KEY_ID }} makepkg -s -f --noconfirm
        working-directory: ./packaging/manjaro
      
      - name: 5. Upload Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: manjaro-package
          path: |
            ./packaging/manjaro/*.pkg.tar.zst
            ./packaging/manjaro/*.pkg.tar.zst.sig

  # ========================================================
  # 1.7 JOB DI BUILD Alpine (MODIFICATO)
  # ========================================================
  build-alpine:
    runs-on: ubuntu-latest
    container:
      image: alpine:latest
    steps:
      - name: 1. Checkout repository code
        uses: actions/checkout@v4
      - name: 2. Prepare Build Environment
        run: |
          apk update
          apk add alpine-sdk git nodejs npm sudo device-mapper jq
      - name: 3. Install PNPM
        run: npm install -g pnpm
      - name: 4. Create Build User, Keys, and Fix Environment
        run: |
          ln -s /usr/lib/libdevmapper.so.1.02 /usr/lib/libdevmapper.so.1.02.1
          ln -s /lib/ld-musl-x86_64.so.1 /lib/libdl.so.2
          adduser -D builder
          addgroup builder abuild
          echo | sudo -u builder abuild-keygen -a
          cp /home/builder/.abuild/*.pub /etc/apk/keys/
          chown -R builder:builder "$GITHUB_WORKSPACE"
      
      # --- MODIFICA: Legge 'release' e aggiorna pkgrel ---
      - name: 5. Update APKBUILD version and release
        run: |
          VERSION=$(jq -r .version package.json)
          RELEASE_NUM=$(cat release | tr -d '[:space:]')
          echo "Building version: $VERSION, release: $RELEASE_NUM"
          sed -i "s/^pkgver=.*/pkgver=$VERSION/" ./packaging/alpine/APKBUILD
          sed -i "s/^pkgrel=.*/pkgrel=$RELEASE_NUM/" ./packaging/alpine/APKBUILD
      
      - name: 6. Build The Package as Non-Root User
        run: |
          sudo -u builder abuild checksum
          sudo -u builder abuild -r
        working-directory: ./packaging/alpine
      - name: 7. Upload Package Artifact
        uses: actions/upload-artifact@v4
        with:
          name: alpine-package
          path: /home/builder/packages/**/*.apk

  # ========================================================
  # 2.0 JOB DI PREPARAZIONE REPO DEBIAN (INVARIATO)
  # ========================================================
  publish-debian-repo:
    needs: [build-debian]
    runs-on: ubuntu-latest
    container: debian:13
    
    steps:
      - name: 1. Install Debian Dependencies
        run: |
          apt-get update
          apt-get install -y apt-utils gnupg dpkg dpkg-dev        

      - name: 2. Import GPG Key
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          echo "${{ secrets.GPG_SIGNING_KEY }}" | gpg --import --batch
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null

      - name: 3. Create Debian Repo Structure
        run: |
          mkdir -p ./repo-dir/deb/pool/main
          mkdir -p ./repo-dir/deb/dists/stable/main/binary-amd64
          mkdir -p ./repo-dir/deb/dists/stable/main/binary-arm64
          mkdir -p ./repo-dir/deb/dists/stable/main/binary-i386      

      - name: 4. Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-packages
          path: ./repo-dir/deb/pool/main/

      - name: 5. Update Debian Repo (NO Pruning)
        env:
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        working-directory: ./repo-dir/deb
        run: |
          set -e
          echo "--- DEBIAN: Genero file Packages ---"
          dpkg-scanpackages -a amd64 pool/main > dists/stable/main/binary-amd64/Packages
          gzip -9c dists/stable/main/binary-amd64/Packages > dists/stable/main/binary-amd64/Packages.gz
          
          dpkg-scanpackages -a arm64 pool/main > dists/stable/main/binary-arm64/Packages
          gzip -9c dists/stable/main/binary-arm64/Packages > dists/stable/main/binary-arm64/Packages.gz
          
          dpkg-scanpackages -a i386 pool/main > dists/stable/main/binary-i386/Packages
          gzip -9c dists/stable/main/binary-i386/Packages > dists/stable/main/binary-i386/Packages.gz
          
          echo "--- DEBIAN: Genero file Release ---"
          apt-ftparchive \
            -o APT::FTPArchive::Release::Origin="Penguins-Eggs" \
            -o APT::FTPArchive::Release::Label="Penguins-Eggs" \
            -o APT::FTPArchive::Release::Suite="stable" \
            -o APT::FTPArchive::Release::Codename="stable" \
            -o APT::FTPArchive::Release::Architectures="amd64 arm64 i386" \
            -o APT::FTPArchive::Release::Components="main" \
            release dists/stable > dists/stable/Release
            
          echo "--- DEBIAN: Firmo file Release (creo InRelease) ---"
          gpg --default-key "$GPG_KEY_ID" \
              --clearsign \
              -o dists/stable/InRelease \
              --batch --yes --passphrase "$GPG_PASSPHRASE" \
              dists/stable/Release
      
      - name: 6. Upload Final Debian Repo Artifact
        uses: actions/upload-artifact@v4
        with:
          name: final-debian-repo
          path: ./repo-dir/
          retention-days: 1
  


# ========================================================
  # 2.1 JOB DI PUBBLICAZIONE (Logica Corretta: Upload-then-Prune)
  # ========================================================
  publish-all-repos:
    needs: [build-debian, build-fc42, build-opensuse, build-el9, build-arch, build-manjaro, build-alpine, publish-debian-repo]
    runs-on: ubuntu-latest
    container: archlinux
    
    steps:
      - name: 1. Install Dependencies
        run: |
          pacman-key --init && pacman-key --populate archlinux
          pacman -Syu --noconfirm
          # 'openssh' fornisce scp e ssh
          pacman -S --noconfirm pacman-contrib gnupg createrepo_c apk-tools openssh

      - name: 2. Create publish directory structure
        run: |
          mkdir -p ./repo-dir/deb
          mkdir -p ./repo-dir/arch
          mkdir -p ./repo-dir/manjaro
          mkdir -p ./repo-dir/alpine
          mkdir -p ./repo-dir/rpm/fedora/42
          mkdir -p ./repo-dir/rpm/opensuse/leap
          mkdir -p ./repo-dir/rpm/el9

      # ... (Tutti gli step '3.x Download Artifacts' rimangono INVARIATI) ...
      - name: 3.1 Download FINAL Debian Repo artifact
        uses: actions/download-artifact@v4
        with:
          name: final-debian-repo
          path: ./repo-dir/
      - name: 3.2 Download Fedora 42 artifacts
        uses: actions/download-artifact@v4
        with:
          name: fedora-42-rpm-for-repo
          path: ./repo-dir/rpm/fedora/42/
      - name: 3.3 Download openSUSE artifacts
        uses: actions/download-artifact@v4
        with:
          name: opensuse-leap-rpm-for-repo
          path: ./repo-dir/rpm/opensuse/leap/
      - name: 3.4 Download EL9 artifacts
        uses: actions/download-artifact@v4
        with:
          name: el9-rpm-for-repo
          path: ./repo-dir/rpm/el9/
      - name: 3.5 Download Arch artifacts
        uses: actions/download-artifact@v4
        with:
          name: arch-packages
          path: ./repo-dir/arch/
      - name: 3.6 Download Manjaro artifacts
        uses: actions/download-artifact@v4
        with:
          name: manjaro-package
          path: ./repo-dir/manjaro/
      - name: 3.7 Download Alpine artifacts
        uses: actions/download-artifact@v4
        with:
          name: alpine-package
          path: ./repo-dir/alpine/

      # ... (Gli step '4' e '4a' per GPG rimangono INVARIATI) ...
      - name: 4. Import GPG Key
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
        run: echo "$GPG_SIGNING_KEY" | gpg --import --batch
      - name: 4a. Immetti la passphase!!!
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" > ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          gpg-connect-agent reloadagent /bye
          echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 -o /dev/null -s /dev/null

      # --- GLI STEP 5, 6, 7, 8 SONO STATI CANCELLATI ---
      # La pulizia e l'indicizzazione avvengono ora sul server.
      
      - name: 9. Setup SSH e Upload NUOVI pacchetti (con SCP)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: /var/www/html/repos
        run: |
          echo "--- 1. Installing private key ---"
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_key
          chmod 600 ~/.ssh/id_key
          
          # Usiamo 'scp -r' che *unisce* le directory, non sovrascrive
          echo "--- 2. Uploading ALL new packages via SCP ---"
          
          # 'scp' unisce le directory. 
          # Copia il *contenuto* di ./repo-dir/ in /var/www/html/repos/
          # Es: ./repo-dir/arch/*.zst -> /var/www/html/repos/arch/*.zst
          scp -v -r -i ~/.ssh/id_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ./repo-dir/* \
            "$SSH_USER@$SSH_HOST:$SERVER_PATH/"

      - name: 10. Esegui Pulizia e Re-indicizzazione (Remoto via SSH)
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
          SSH_HOST: ${{ secrets.SERVER_HOST }}
          SSH_USER: ${{ secrets.SERVER_USER }}
          SERVER_PATH: /var/www/html/repos
          GPG_KEY_ID: ${{ secrets.GPG_KEY_ID }}
          ALPINE_SIGNING_KEY_PUB_CONTENT: ${{ secrets.ALPINE_SIGNING_KEY_PUB }}
        run: |
          echo "--- 1. Installing private key (per SSH) ---"
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_key
          chmod 600 ~/.ssh/id_key
          
          # Questo è un unico, grande script eseguito sul server
          echo "--- 2. Running remote prune and re-index script ---"
          ssh -v -i ~/.ssh/id_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            "$SSH_USER@$SSH_HOST" "
            
            # Attiva la modalità 'exit on error' sul server
            set -e
            
            # --- 1. PULIZIA ARCH ---
            echo '--- [REMOTO] ARCH: Cleaning old packages ---'
            cd $SERVER_PATH/arch
            # NOTA: Questa è la regex CORRETTA che funziona anche per calamares-eggs
            PKG_BASES=\$(find . -maxdepth 1 -name '*.pkg.tar.zst' -exec basename {} \; | sed -E 's/(.*)-[0-9]+\..*/\1/' | sort -u)
            for base in \$PKG_BASES; do
              echo \"Processing: \$base\"
              ls \${base}-*.pkg.tar.zst 2>/dev/null | sort -V | head -n -1 | xargs -r rm -vf
              ls \${base}-*.pkg.tar.zst.sig 2>/dev/null | sort -V | head -n -1 | xargs -r rm -vf
            done
            echo '--- [REMOTO] ARCH: Re-indexing ---'
            rm -f penguins-eggs.db.tar.gz penguins-eggs.files.tar.gz
            repo-add --sign --key '$GPG_KEY_ID' penguins-eggs.db.tar.gz *.pkg.tar.zst

            # --- 2. PULIZIA MANJARO ---
            echo '--- [REMOTO] MANJARO: Cleaning old packages ---'
            cd $SERVER_PATH/manjaro
            PKG_BASES=\$(find . -maxdepth 1 -name '*.pkg.tar.zst' -exec basename {} \; | sed -E 's/(.*)-[0-9]+\..*/\1/' | sort -u)
            for base in \$PKG_BASES; do
              echo \"Processing: \$base\"
              ls \${base}-*.pkg.tar.zst 2>/dev/null | sort -V | head -n -1 | xargs -r rm -vf
              ls \${base}-*.pkg.tar.zst.sig 2>/dev/null | sort -V | head -n -1 | xargs -r rm -vf
            done
            echo '--- [REMOTO] MANJARO: Re-indexing ---'
            rm -f penguins-eggs.db.tar.gz penguins-eggs.files.tar.gz
            repo-add --sign --key '$GPG_KEY_ID' penguins-eggs.db.tar.gz *.pkg.tar.zst

            # --- 3. PULIZIA ALPINE ---
            echo '--- [REMOTO] ALPINE: Cleaning old packages ---'
            cd $SERVER_PATH/alpine
            # Sposta i file da sottodirectory se 'scp' li ha creati
            find . -mindepth 2 -type f -name '*.apk' -exec mv {} . \;
            PKG_BASES=\$(find . -maxdepth 1 -name '*.apk' -exec basename {} \; | sed -E 's/(.*)-[0-9]+\..*/\1/' | sort -u)
            for base in \$PKG_BASES; do
              echo \"Processing: \$base\"
              ls \${base}-[0-9]*.apk 2>/dev/null | sort -V | head -n -1 | xargs -r rm -vf
            done
            echo '--- [REMOTO] ALPINE: Re-indexing ---'
            rm -f APKINDEX.tar.gz
            apk index -o APKINDEX.tar.gz *.apk --allow-untrusted
            # Ricrea la chiave pubblica
            echo '$ALPINE_SIGNING_KEY_PUB_CONTENT' > penguins-eggs.rsa.pub

            # --- 4. RE-INDEx RPM (Nessuna pulizia richiesta) ---
            echo '--- [REMOTO] RPM: Re-indexing ---'
            cd $SERVER_PATH/rpm/fedora/42; rm -rf repodata; createrepo_c .;
            cd $SERVER_PATH/rpm/opensuse/leap; rm -rf repodata; createrepo_c .;
            cd $SERVER_PATH/rpm/el9; rm -rf repodata; createrepo_c .;
            
            echo '--- [REMOTO] All operations complete ---'
            "