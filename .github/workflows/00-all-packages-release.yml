name: '00 - all packages release'

on:
  workflow_dispatch:

jobs:
  trigger-all-releases:
    name: Trigger di Rilascio Globale
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read # Necessario per gh run list

    steps:
      - name: Checkout del codice del repository
        uses: actions/checkout@v4

      - name: Avvia i workflow di pubblicazione in sequenza
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Interrompe l'intero script se un comando fallisce 
          set -e

          echo "Inizio a chiamare i singoli workflow in modo sequenziale..."
          echo "Tutti i rilasci verranno eseguiti usando il codice dal branch 'master'."

          # Lista dei workflow da eseguire in ordine
          WORKFLOWS=(
            "00-publish-debian-deb.yml"
            "01-publish-fedora-rpm.yml"
            "02-publish-opensuse-rpm.yml"
            "03-publish-enterprise-linux.yml"
            "04-publish-archlinux.yml"
            "05-publish-manjaro.yml"
            "06-publish-alpine.yml"
          )

          for workflow_file in "${WORKFLOWS[@]}"; do
            echo "------------------------------------------------------"
            echo "üöÄ Avvio del workflow: ${workflow_file}"
            gh workflow run "${workflow_file}" --ref master

            echo "üîç Recupero l'ID dell'esecuzione ATTIVA (riprovo per 60s)..."
            RUN_ID=""
            # Tenta per 60 secondi (12 tentativi ogni 5s) di trovare l'ID
            for i in $(seq 1 12); do
            
              # --- MODIFICA CHIAVE ---
              # Aggiunto '--status=in_progress,queued' per trovare SOLO 
              # l'esecuzione che abbiamo appena avviato, ignorando quelle vecchie.
              RUN_ID=$(gh run list --workflow="${workflow_file}" --branch="master" --status=in_progress,queued --limit=1 --json databaseId -q '.[0].databaseId')
              
              if [ -n "$RUN_ID" ]; then
                echo "üéâ Trovato ID esecuzione attiva: ${RUN_ID}"
                break
              fi
              echo "...ancora non trovato, attendo 5s..."
              sleep 5
            done

            # Se dopo 60 secondi l'ID non si trova, esci con errore
            if [ -z "$RUN_ID" ]; then
              echo "‚ùå Errore: Impossibile trovare l'ID dell'esecuzione per ${workflow_file} dopo 60 secondi."
              exit 1
            fi
            
            echo "‚è≥ Attendo il completamento dell'esecuzione ID: ${RUN_ID}..."
            
            # Ora 'gh run watch' attender√† l'ID CORRETTO.
            gh run watch "${RUN_ID}" --exit-status
            
            echo "‚úÖ Workflow ${workflow_file} completato con successo."

          done

          echo "------------------------------------------------------"
          echo "üéâ Processo completato. Tutti i workflow sono stati eseguiti in sequenza."

